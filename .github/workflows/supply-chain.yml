name: Supply Chain Pinning

on:
  pull_request:
    paths:
      - '.github/workflows/**'

permissions:
  contents: read

jobs:
  pin-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure actions are pinned to commit SHAs
        shell: bash
        run: |
          set -euo pipefail
          rc=0
          while IFS= read -r f; do
            # Find all uses: lines and ensure they end with a 40-char hex SHA
            if grep -P "^\s*uses:\s*[^@]+@([a-f0-9]{40})\s*$" "$f" > /dev/null; then
              :
            else
              echo "âœ— Not pinned to SHA in: $f";
              grep -n "^\s*uses:" "$f" || true
              rc=1
            fi
          done < <(git ls-files '.github/workflows/*.yml')
          exit $rc
